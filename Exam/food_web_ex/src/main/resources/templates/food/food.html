<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>요리</title>
    {{> ./include/css}}
</head>
<body>
{{> ./include/topmenu}}
<div class="container">
    <div>
        <div class="row">
            <div class="col-lg-12">
                <div class="page-header">
                    <h1 id="tables">요리</h1>
                </div>
                <div>
                    <nav class="navbar navbar-expand-lg bg-primary" data-bs-theme="light">
                        <div class="container-fluid">
                            <button type="button" id="showAddModalButton" class="btn btn-primary">추가</button>
                            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
                                <span class="navbar-toggler-icon"></span>
                            </button>
                            <div class="collapse navbar-collapse" id="navbarColor01">
                                <ul class="navbar-nav me-auto">
                                    <li class="nav-item dropdown">
                                        <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false" id="pageSize">10</a>
                                        <div class="dropdown-menu">
                                            <a class="dropdown-item" href="javascript:$.setPageSize(5);">5</a>
                                            <a class="dropdown-item" href="javascript:$.setPageSize(10);">10</a>
                                            <a class="dropdown-item" href="javascript:$.setPageSize(20);">20</a>
                                            <a class="dropdown-item" href="javascript:$.setPageSize(30);">30</a>
                                        </div>
                                    </li>
                                </ul>
                                <form class="d-flex">
                                    <input id="searchText" class="form-control me-sm-2" type="search" placeholder="이름검색">
                                    <button id="searchButton" class="btn btn-secondary my-2 my-sm-0" type="submit">Search</button>
                                </form>
                            </div>
                        </div>
                    </nav>
                    <button class="source-button btn btn-primary btn-xs" type="button" tabindex="0"><i class="bi bi-code"></i></button><button class="source-button btn btn-primary btn-xs" type="button" tabindex="0"><i class="bi bi-code"></i></button>
                </div>
                <div>
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th scope="col">ID<span id="id_desc" class="sortButton sortDesc">▼</span><span id="id_asc" class="sortButton sortAsc">△</span></th>
                            <th scope="col">Name<span id="name_desc" class="sortButton sortDesc">▽</span><span id="name_asc" class="sortButton sortAsc">△</span></th>
                            <th scope="col">SpicyLevel<span id="spicyLevel_desc" class="sortButton sortDesc">▽</span><span id="spicyLevel_asc" class="sortButton sortAsc">△</span></th>
                            <th scope="col">SweetLevel<span id="sweetLevel_desc" class="sortButton sortDesc">▽</span><span id="sweetLevel_asc" class="sortButton sortAsc">△</span></th>
                            <th scope="col">SourLevel<span id="sourLevel_desc" class="sortButton sortDesc">▽</span><span id="sourLevel_asc" class="sortButton sortAsc">△</span></th>
                            <th scope="col">SaltyLevel<span id="saltyLevel_desc" class="sortButton sortDesc">▽</span><span id="saltyLevel_asc" class="sortButton sortAsc">△</span></th>
                            <th scope="col">FoodCategoryName<span id="foodCategoryId_desc" class="sortButton sortDesc">▽</span><span id="foodCategoryId_asc" class="sortButton sortAsc">△</span></th>
                        </tr>
                        </thead>
                        <tbody id="listBody">
                        <tr>
                            <th scope="row">Default</th>
                            <td>Column content</td>
                        </tr>
                        </tbody>
                    </table>
                    <button class="source-button btn btn-primary btn-xs" type="button" tabindex="0"><i class="bi bi-code"></i></button></div><!-- /example -->
            </div>
        </div>
        <ul class="pagination" id="paginationUL">
        </ul>
    </div>
    <div class="bs-docs-section">
        <div id="modal_box_add" style="display: none" class="row">
            <div class="col-lg-12">
                <h2>Modals</h2>
                <div class="bs-component">
                    <div class="modal">
                        <div class="modal-dialog" role="document">
                            <div id="modalDialog" class="modal-content">
                                <div class="modal-header">
                                    <h5 id="modal_title" class="modal-title"></h5>
                                </div>
                                <div class="modal-body">
                                    <div>
                                        <div>
                                            <label class="col-form-label mt-4" for="id">id</label>
                                            <input type="text" class="form-control" placeholder="id" id="id" disabled="">
                                        </div>
                                        <div>
                                            <label class="col-form-label mt-4" for="name">요리 이름</label>
                                            <input type="text" class="form-control" placeholder="음식분류" id="name" maxlength="40">
                                        </div>
                                        <div>
                                            <label class="col-form-label mt-4" for="spicyLevel">SpicyLevel</label>
                                            <input type="number" class="form-control" placeholder="" id="spicyLevel" max="10" min="0 ">
                                        </div>
                                        <div>
                                            <label class="col-form-label mt-4" for="sweetLevel">SweetLevel</label>
                                            <input type="number" class="form-control" placeholder="" id="sweetLevel" max="10" min="0">
                                        </div>
                                        <div>
                                            <label class="col-form-label mt-4" for="sourLevel">SourLevel</label>
                                            <input type="number" class="form-control" placeholder="" id="sourLevel" max="10" min="0">
                                        </div>
                                        <div>
                                            <label class="col-form-label mt-4" for="saltyLevel">SaltyLevel</label>
                                            <input type="number" class="form-control" placeholder="" id="saltyLevel" max="10" min="0">
                                        </div>
                                        <div>
                                            <label class="col-form-label mt-4" for="foodCategoryName">요리 종류</label>
                                            <select id="foodCategoryName">
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" id="saveButton" class="btn btn-primary">저장</button>
                                    <button type="button" id="deleteButton" class="btn btn-primary">삭제</button>
                                    <button type="button" class="btn btn-secondary modalCloseButton" data-bs-dismiss="modal">닫기</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal_bg" style="display: none"></div>
    </div>
</div>
{{> ./include/footer}}

<script src="/bootswatch/brite/js/bootstrap.bundle.min.js"></script>
<script src="/bootswatch/brite/js/prism.js" data-manual></script>
<script src="/bootswatch/brite/js/custom.js"></script>
<script src="/js/jquery-3.7.1.min.js"></script>

<script>
    let modalMode = 1;
    let sortString = "id,desc";
    let curPage = 1;
    $(document).ready(function(){
        $.loadData($.getPagable());
        $.categoryList();

        $('#showAddModalButton').click(function () {
            // id="modal_box_add" 요소를 1000ms 동안 서서히 보여준다.
            $.showModal(1);
        });

        $('.modalCloseButton').click(function () {
            // id="modal_box_add" 요소와 class="modal_bg" 요소를 서서히 감춘다.
            $.clearModalForm();
            $('#modal_box_add').fadeOut();
            $('.modal_bg').fadeOut();
        });

        $("#saveButton").click(function() {
            if ( modalMode === 1 ) {
                $.insert();
            } else if ( modalMode === 2 ) {
                $.update();
            }
        });

        $("#deleteButton").click(function() {
            $.delete();
            $('#modal_box_add').fadeOut();
            $('.modal_bg').fadeOut();
        });

        $(".sortButton").click(function() {
            $.getSortButton(this);
        });

        $("#searchButton").click(function(){
            $.loadData($.getPagable());
        });
    });

    $.setPageSize = (num) => {
        $("#pageSize").text(num);
        $.loadData($.getPagable());
    }

    $.getPagable = () => {
        let data = {
            "name": $("#searchText").val(),
            "page": curPage - 1,
            "size": $("#pageSize").text(),
            "sort": sortString,
        };
        return data;
    }

    $.loadData = (pagable) => {
        let url = `?name=${pagable.name}&page=${pagable.page}&size=${pagable.size}&sort=${pagable.sort}`;
        $.ajax({
            url: '/api/v1/food/search' + url,
            method: 'GET'
        }).done(function(data, textStatus, jqXHR) {
            console.log("Success:", data.result);
            $.printList(data.result);
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.log("Error:", textStatus, errorThrown);
            alert(`${jqXHR.responseJSON.code} : ${jqXHR.responseJSON.message}`);
        });
    }

    $.categoryList = () => {
        $.ajax({
            url: '/api/v1/food_category',
            method: 'GET'
        }).done(function(data, textStatus, jqXHR) {
            console.log("Success:", data.result);
            $.printList2(data.result);
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.log("Error:", textStatus, errorThrown);
            alert(`${jqXHR.responseJSON.code} : ${jqXHR.responseJSON.message}`);
        });
    }

    $.printList2 = function(result) {
        $.makeDataRows2(result);
    }

    $.makeDataRows2 = function(list) {
        let html2 = "";
        for ( let i = 0; i < list.length; i++ ) {
            html2 += $.makeSelectCategory(list[i]);
        }
        $("#foodCategoryName").empty();
        $("#foodCategoryName").append(html2);
    }

    $.makeSelectCategory = function (item){
        let html = `<option value="${item.id}">${item.name}</option>`
        return html;
    }

    $.printList = function(result) {
        $.makeDataRows(result.content);
        $.makePageButtons(result);
    }

    $.makeOneRow = function(item) {
        let html = `<tr onclick="$.showInfo(${item.id})">
                        <th scope="row">${item.id}</th>
                        <td>${item.name}</td>
                        <td>${item.spicyLevel}</td>
                        <td>${item.sweetLevel}</td>
                        <td>${item.sourLevel}</td>
                        <td>${item.saltyLevel}</td>
                        <td>${item.foodCategoryEntity.name}</td>
                    </tr>`;
        return html;
    }



    $.makeDataRows = function(list) {
        let html = "";
        for ( let i = 0; i < list.length; i++ ) {
            html += $.makeOneRow(list[i]);
        }
        $("#listBody").empty();
        $("#listBody").append(html);
    }

    $.makePageButtons = function(result) {
        let html = "";
        html += $.makePrevButton(result.pageable.pageNumber + 1);
        html += $.makeFSTFFButtons(result.pageable.pageNumber + 1, result.totalPages);
        html += $.makeNextButton(result.pageable.pageNumber + 1, result.totalPages);
        $("#paginationUL").empty();
        $("#paginationUL").append(html);
    }

    $.makePrevButton = function(curPage) {
        if ( curPage <= 1 ) {
            return `<li class="page-item disabled">
                        <a class="page-link" href="#" id="pagePrev">«</a>
                    </li>`;
        } else {
            return `<li class="page-item">
                        <a class="page-link" href="javascript:$.goPage(${curPage - 1});" id="pagePrev">«</a>
                    </li>`;
        }
    }

    $.makeFSTFFButtons = function(curPage, maxPage) {
        let startPage = (curPage - 2) <= 0 ? 1 : curPage - 2;
        let lastPage = curPage + 2 >= maxPage ? maxPage : curPage + 2 <= 5 && maxPage >= 5 ? 5 : curPage + 2;
        // lastPage = lastPage >= maxPage ? maxPage : lastPage;
        //
        // 현재페이지    출력페이지   max페이지
        // 2            12345       7
        // 1            12345       7
        // 4            23456       7
        // 6            4567        7
        let html = "";
        for ( let count = 1, page = startPage; count <= 5 && page <= lastPage; count++, page++ ) {
            if ( page === curPage ) {
                html += `<li class="page-item active">
                            <a class="page-link" href="javascript:$.goPage(${page});">${page}</a>
                        </li>`
            } else {
                html += `<li class="page-item">
                            <a class="page-link" href="javascript:$.goPage(${page});">${page}</a>
                        </li>`
            }
        }
        return html;
    }

    $.makeNextButton = function(curPage, maxPage) {
        if ( curPage >= maxPage ) {
            return `<li class="page-item disabled">
                        <a class="page-link" href="#" id="pageNext">»</a>
                    </li>`;
        } else {
            return `<li class="page-item">
                        <a class="page-link" href="javascript:$.goPage(${curPage + 1});" id="pageNext">»</a>
                    </li>`;
        }
    }

    $.goPage = function(goPage) {
        curPage = goPage;
        $.loadData($.getPagable());
    }

    $.getSortButton = (tag) => {
        let str = $(tag)[0].id;
        let arr = str.split("_");
        let req = `${arr[0]},${arr[1]}`;
        console.log( req );

        $(".sortDesc").text("▽");
        $(".sortAsc").text("△");
        if( arr[1] === "desc") {
            $("#"+str).text("▼")
        } else {
            $("#"+str).text("▲")
        }

        sortString = req;
        $.loadData($.getPagable());
    }

    $.insert = function() {
        let dataMember = {
            // "id": 0,
            "name": $("#name").val(),
            "foodCategoryId": $("#foodCategoryName").val(),
            "spicyLevel" : $("#spicyLevel").val(),
            "sweetLevel" : $("#sweetLevel").val(),
            "sourLevel" : $("#sourLevel").val(),
            "saltyLevel" : $("#saltyLevel").val(),
        };

        $.ajax({
            url: '/api/v1/food',
            type: "POST",
            data: JSON.stringify(dataMember),
            datatype: "JSON",
            contentType: 'application/json',
        }).done(function(data, textStatus, jqXHR) {
            console.log("Success:", data.result);
            $.loadData($.getPagable());
            $(".modalCloseButton").trigger("click");
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.log("Error:", textStatus, errorThrown);
            alert(`${jqXHR.responseJSON.code} : ${jqXHR.responseJSON.message}`);
        });
    };

    $.clearModalForm = () => {
        $("#id").val("");
        $("#name").val("");
        $("#foodCategoryName").val("");
        $("#spicyLevel").val("");
        $("#sweetLevel").val("");
        $("#sourLevel").val("");
        $("#saltyLevel").val("");
    }

    $.showModal = (mode) => {
        $('#modal_box_add').fadeIn(500);
        $('.modal_bg').fadeIn(500);
        if( mode === 1 ) {
            $("#modal_title").text("입력 창")
        } else if ( mode === 2 ) {
            $("#modal_title").text("보기/수정 창")
        }
        modalMode = mode;
    }

    $.showInfo = function(id) {
        $.ajax({
            url: '/api/v1/food/' + id,
            method: 'GET'
        }).done(function(data, textStatus, jqXHR) {
            console.log("Success:", data.result);
            $.printOne(data.result);
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.log("Error:", textStatus, errorThrown);
            alert(`${jqXHR.responseJSON.code} : ${jqXHR.responseJSON.message}`);
        });
    };

    $.printOne = function(item) {
        if(item == null || item == undefined) {
            return;
        }
        $("#id").val(item.id);
        $("#name").val(item.name);
        $("#foodCategoryName").val(item.foodCategoryEntity.id);
        $("#spicyLevel").val(item.spicyLevel);
        $("#sweetLevel").val(item.sweetLevel);
        $("#sourLevel").val(item.sourLevel);
        $("#saltyLevel").val(item.saltyLevel);

        $.showModal(2);
    }


    $.update = function() {
        let dataMember = {
            "id": $("#id").val(),
            "name": $("#name").val(),
            "foodCategoryId": $("#foodCategoryName").val(),
            "spicyLevel" : $("#spicyLevel").val(),
            "sweetLevel" : $("#sweetLevel").val(),
            "sourLevel" : $("#sourLevel").val(),
            "saltyLevel" : $("#saltyLevel").val(),
        };

        $.ajax({
            url: '/api/v1/food/' + $("#id").val(),
            type: "PATCH",
            data: JSON.stringify(dataMember),
            datatype: "JSON",
            contentType: 'application/json',
        }).done(function(data, textStatus, jqXHR) {
            console.log("Success:", data.result);
            $.loadData($.getPagable());
            $(".modalCloseButton").trigger("click");
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.log("Error:", textStatus, errorThrown);
            alert(`${jqXHR.responseJSON.code} : ${jqXHR.responseJSON.message}`);
        });
    };

    $.delete = function() {
        $.ajax({
            url: '/api/v1/food/' + $("#id").val(),
            type: "DELETE",
        }).done(function(data, textStatus, jqXHR) {
            console.log("Success:", data.result);
            $.loadData($.getPagable());
            $(".modalCloseButton").trigger("click");
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.log("Error:", textStatus, errorThrown);
            alert(`${jqXHR.responseJSON.code} : ${jqXHR.responseJSON.message}`);
        });
    };
</script>
</body>
</html>